<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<title>MathDrop Academy</title>
	<style>
		body {
			font-family: 'Courier New', monospace;
			margin: 0;
			background: #f0f0f0;
			image-rendering: pixelated;
			image-rendering: -moz-crisp-edges;
			image-rendering: crisp-edges;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			-webkit-tap-highlight-color: transparent;
			touch-action: manipulation;
		}

		/* Screen Management */
		.screen {
			display: none;
			width: 100%;
			height: 100vh;
			position: relative;
		}

		.screen.active {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		/* Loading Screen */
		.loading-screen {
			background: #1a1a1a;
			background-image: 
				repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,65,.03) 2px, rgba(0,255,65,.03) 4px),
				repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,255,65,.03) 2px, rgba(0,255,65,.03) 4px);
			color: #00ff41;
		}

		.loading-content {
			text-align: center;
			max-width: 500px;
			padding: 40px;
			background: #333333;
			border: 4px solid #00ff41;
			border-radius: 0;
			box-shadow: 
				6px 6px 0px #000000,
				12px 12px 0px rgba(0, 0, 0, 0.5);
		}

		.loading-title {
			font-size: 4em;
			font-weight: bold;
			margin-bottom: 20px;
			text-shadow: 3px 3px 0px #000000;
			font-family: 'Courier New', monospace;
			letter-spacing: 3px;
			color: #00ff41;
			animation: pixelFlicker 2s infinite;
		}

		.loading-subtitle {
			font-size: 1.5em;
			margin-bottom: 40px;
			color: #66ff66;
			text-shadow: 2px 2px 0px #000000;
			font-family: 'Courier New', monospace;
			letter-spacing: 2px;
		}

		.loading-bar-container {
			width: 100%;
			height: 24px;
			background: #000000;
			border: 3px solid #00ff41;
			border-radius: 0;
			margin: 30px 0;
			overflow: hidden;
			box-shadow: inset 2px 2px 0px rgba(0, 0, 0, 0.8);
		}

		.loading-bar {
			height: 100%;
			background: #00ff41;
			border-radius: 0;
			transition: width 0.3s ease;
			width: 0%;
			box-shadow: 
				inset 0 2px 0px #66ff66,
				0 0 8px rgba(0, 255, 65, 0.5);
			animation: pixelScan 1s infinite linear;
		}

		.loading-text {
			font-size: 1.2em;
			margin-top: 20px;
			color: #cccccc;
			text-shadow: 1px 1px 0px #000000;
			font-family: 'Courier New', monospace;
			letter-spacing: 1px;
			animation: pixelBlink 1.5s infinite;
		}

		/* Level Picker Screen */
		.level-picker-screen {
			background: #1a1a1a;
			background-image: 
				repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,.03) 2px, rgba(255,255,255,.03) 4px),
				repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255,255,255,.03) 2px, rgba(255,255,255,.03) 4px);
			color: #00ff41;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
			padding: 10px 0;
		}

		.level-picker-content {
			max-width: 1200px;
			width: 100%;
			padding: 15px;
			text-align: center;
			box-sizing: border-box;
		}

		.level-picker-title {
			font-size: clamp(1.8em, 4vw, 2.5em);
			font-weight: bold;
			margin-bottom: 15px;
			text-shadow: 2px 2px 0px #000000;
			letter-spacing: 2px;
		}

		.level-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 15px;
			margin: 20px 0;
			max-height: 70vh;
			max-height: 70dvh;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
			padding: 5px;
			box-sizing: border-box;
		}

		.level-card {
			background: #333333;
			color: #00ff41;
			padding: 15px;
			border-radius: 0;
			border: 4px solid #00ff41;
			border-style: solid;
			box-shadow: 
				4px 4px 0px #000000,
				8px 8px 0px rgba(0, 0, 0, 0.3);
			cursor: pointer;
			transition: none;
			text-align: center;
			min-height: 120px;
			display: flex;
			flex-direction: column;
			justify-content: center;
			box-sizing: border-box;
			position: relative;
			-webkit-tap-highlight-color: rgba(0, 255, 65, 0.2);
			touch-action: manipulation;
			user-select: none;
			-webkit-user-select: none;
		}

		.level-card:hover:not(.locked) {
			transform: translate(-2px, -2px);
			box-shadow: 
				6px 6px 0px #000000,
				10px 10px 0px rgba(0, 0, 0, 0.3);
			border-color: #66ff66;
			background: #444444;
			color: #66ff66;
		}

		.level-card.locked {
			background: #222222;
			color: #666666;
			border-color: #666666;
			border-style: dashed;
			cursor: not-allowed;
			opacity: 0.7;
			box-shadow: 
				2px 2px 0px #000000,
				4px 4px 0px rgba(0, 0, 0, 0.2);
		}

		.level-card.locked .level-card-number {
			color: #666666;
		}

		.level-card-number {
			font-size: 2.2em;
			font-weight: bold;
			margin-bottom: 6px;
			color: #00ff41;
			text-shadow: 2px 2px 0px #000000;
			font-family: 'Courier New', monospace;
		}

		.level-card-title {
			font-size: 1.1em;
			font-weight: bold;
			margin-bottom: 6px;
			line-height: 1.1;
			text-shadow: 1px 1px 0px #000000;
			letter-spacing: 1px;
		}

		.level-card-desc {
			font-size: 0.85em;
			opacity: 0.9;
			line-height: 1.2;
			color: #cccccc;
			text-shadow: 1px 1px 0px #000000;
		}

		/* Game Screen */
		.game-screen {
			background: #1a1a1a;
			background-image: 
				repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,65,.03) 2px, rgba(0,255,65,.03) 4px),
				repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,255,65,.03) 2px, rgba(0,255,65,.03) 4px);
			position: relative;
			color: #00ff41;
		}

		.main-container {
			display: grid;
			grid-template-rows: auto 1fr auto;
			gap: 8px;
			max-width: 900px;
			margin: 0 auto;
			height: 100vh;
			height: 100dvh; /* Dynamic viewport height for mobile */
			width: 100%;
			padding: 8px;
			box-sizing: border-box;
			overflow: hidden;
		}

		/* Compact Header Design */
		.compact-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			background: #333333;
			border: 3px solid #00ff41;
			border-radius: 0;
			padding: 8px 12px;
			box-shadow: 
				3px 3px 0px #000000,
				6px 6px 0px rgba(0, 0, 0, 0.3);
			min-height: 40px;
		}

		.header-left,
		.header-right {
			display: flex;
			gap: 8px;
		}

		.header-center {
			flex: 1;
			text-align: center;
		}

		.compact-btn {
			background: #00ff41;
			color: #000000;
			border: 2px solid #66ff66;
			border-radius: 0;
			padding: 8px 12px;
			font-size: 1.1em;
			font-weight: bold;
			cursor: pointer;
			box-shadow: 2px 2px 0px #000000;
			transition: none;
			font-family: 'Courier New', monospace;
			-webkit-tap-highlight-color: rgba(255, 255, 255, 0.2);
			touch-action: manipulation;
		}

		.compact-btn:active {
			transform: translate(1px, 1px);
			box-shadow: 1px 1px 0px #000000;
		}

		.compact-stats {
			display: flex;
			justify-content: center;
			gap: 15px;
			font-family: 'Courier New', monospace;
			color: #00ff41;
			font-weight: bold;
		}

		.stat-item {
			font-size: 0.9em;
			text-shadow: 1px 1px 0px #000000;
		}

		.stat-item strong {
			color: #66ff66;
		}

		/* Compact Status Bar */
		.compact-status {
			background: #333333;
			border: 3px solid #00ff41;
			border-radius: 0;
			padding: 8px 12px;
			box-shadow: 
				3px 3px 0px #000000,
				6px 6px 0px rgba(0, 0, 0, 0.3);
			text-align: center;
		}

		.level-info {
			font-size: 0.8em;
			color: #cccccc;
			margin-top: 4px;
			text-shadow: 1px 1px 0px #000000;
		}

		.title {
			text-align: center;
			background: #333333;
			color: #00ff41;
			padding: 20px;
			border-radius: 0;
			border: 4px solid #00ff41;
			box-shadow: 
				4px 4px 0px #000000,
				8px 8px 0px rgba(0, 0, 0, 0.3);
			position: relative;
			min-height: 60px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.title h1 {
			margin: 0;
			font-size: 2.5em;
			text-shadow: 2px 2px 0px #000000;
			letter-spacing: 2px;
			font-family: 'Courier New', monospace;
		}

		.game-stats {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			padding: 15px;
			background: #333333;
			border: 4px solid #00ff41;
			border-radius: 0;
			box-shadow: 
				4px 4px 0px #000000,
				8px 8px 0px rgba(0, 0, 0, 0.3);
		}

		.score-section,
		.level-section {
			text-align: center;
			padding: 10px;
			border-radius: 8px;
		}

		.score-section {
			background: #222222;
			border: 2px solid #00ff41;
			border-radius: 0;
		}

		.level-section {
			background: #222222;
			border: 2px solid #00ff41;
			border-radius: 0;
		}

		.stat-label {
			font-size: 0.9em;
			color: #00ff41;
			margin-bottom: 5px;
			font-weight: bold;
			text-shadow: 1px 1px 0px #000000;
			letter-spacing: 1px;
		}

		.stat-value {
			font-size: 1.8em;
			font-weight: bold;
			margin-bottom: 10px;
			color: #66ff66;
			text-shadow: 2px 2px 0px #000000;
			font-family: 'Courier New', monospace;
		}

		.sub-stats {
			display: flex;
			justify-content: space-around;
			font-size: 0.9em;
			color: #cccccc;
			text-shadow: 1px 1px 0px #000000;
		}

		.game-container {
			display: flex;
			justify-content: center;
			align-items: center;
			background: #333333;
			border: 4px solid #00ff41;
			border-radius: 0;
			box-shadow: 
				4px 4px 0px #000000,
				8px 8px 0px rgba(0, 0, 0, 0.3);
			padding: 10px;
			min-height: 0;
			overflow: visible;
			flex-shrink: 1;
		}

		#game {
			display: grid;
			grid-template-columns: repeat(10, 45px);
			grid-template-rows: repeat(10, 36px);
			gap: 2px;
			border: 4px solid #00ff41;
			background: #000000;
			border-radius: 0;
			box-shadow: inset 2px 2px 0px rgba(0, 255, 65, 0.3);
			max-width: 100%;
			width: fit-content;
			height: fit-content;
			overflow: visible;
			justify-self: center;
			align-self: center;
		}

		.cell {
			border: 1px solid #00ff41;
			display: flex;
			align-items: center;
			justify-content: center;
			background: #222222;
			font-size: 12px;
			font-weight: bold;
			font-family: 'Courier New', monospace;
			color: #00ff41;
			text-shadow: 1px 1px 0px #000000;
		}

		.falling {
			background: #ff6b6b;
			border: 2px solid #ffffff;
			color: #ffffff;
			font-weight: bold;
			animation: pixelPulse 0.6s infinite;
			box-shadow: 
				2px 2px 0px #000000,
				0 0 8px rgba(255, 107, 107, 0.6);
			text-shadow: 1px 1px 0px #000000;
		}

		.answer {
			background: #00ff41;
			border: 2px solid #66ff66;
			color: #000000;
			font-size: 16px;
			font-weight: bold;
			box-shadow: inset 1px 1px 0px rgba(255, 255, 255, 0.3);
		}

		@keyframes pixelPulse {
			0% {
				transform: scale(1);
				filter: brightness(1);
			}

			50% {
				transform: scale(1.1);
				filter: brightness(1.3);
				box-shadow: 
					3px 3px 0px #000000,
					0 0 12px rgba(255, 107, 107, 0.8);
			}

			100% {
				transform: scale(1);
				filter: brightness(1);
			}
		}

		.game-text {
			text-align: center;
			padding: 12px;
			background: #333333;
			border: 4px solid #00ff41;
			border-radius: 0;
			box-shadow: 
				4px 4px 0px #000000,
				8px 8px 0px rgba(0, 0, 0, 0.3);
			min-height: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
			color: #00ff41;
			text-shadow: 1px 1px 0px #000000;
			font-family: 'Courier New', monospace;
		}

		.status-correct {
			color: #66ff66;
			font-size: 1.5em;
			font-weight: bold;
			text-shadow: 2px 2px 0px #000000;
			animation: pixelGlow 0.5s ease-in-out;
		}

		.status-wrong {
			color: #ff6666;
			font-size: 1.5em;
			font-weight: bold;
			text-shadow: 2px 2px 0px #000000;
			animation: pixelShake 0.5s ease-in-out;
		}

		.status-default {
			color: #cccccc;
			font-size: 1.2em;
			text-shadow: 1px 1px 0px #000000;
		}

		.level-selector {
			display: flex;
			flex-wrap: wrap;
			gap: 5px;
			justify-content: center;
		}

		.level-btn {
			padding: 5px 8px;
			border: 2px solid #FF9800;
			background: white;
			border-radius: 5px;
			cursor: pointer;
			font-size: 0.8em;
			font-weight: bold;
			color: #FF9800;
			transition: all 0.2s;
		}

		.level-btn:hover {
			background: #FF9800;
			color: white;
		}

		.level-btn.active {
			background: #FF9800;
			color: white;
		}

		.level-btn:disabled {
			background: #ccc;
			border-color: #ccc;
			color: #999;
			cursor: not-allowed;
		}

		/* Mobile Control Buttons */
		.mobile-controls {
			display: flex;
			justify-content: center;
			gap: 15px;
			padding: 10px;
			background: rgba(51, 51, 51, 0.9);
			border-top: 3px solid #00ff41;
			position: sticky;
			bottom: 0;
			left: 0;
			right: 0;
			z-index: 100;
			backdrop-filter: blur(5px);
		}

		.mobile-btn {
			background: #333333;
			color: #00ff41;
			border: 3px solid #00ff41;
			border-radius: 0;
			padding: 15px 20px;
			font-size: 1.2em;
			font-weight: bold;
			font-family: 'Courier New', monospace;
			cursor: pointer;
			box-shadow: 
				3px 3px 0px #000000,
				6px 6px 0px rgba(0, 0, 0, 0.3);
			transition: none;
			-webkit-tap-highlight-color: rgba(0, 255, 65, 0.5);
			touch-action: manipulation;
			user-select: none;
			-webkit-user-select: none;
			min-width: 60px;
			position: relative;
			z-index: 1000;
		}

		.mobile-btn:active {
			transform: translate(2px, 2px);
			box-shadow: 
				1px 1px 0px #000000,
				2px 2px 0px rgba(0, 0, 0, 0.3);
			background: #00ff41;
			color: #000000;
		}

		/* Hide mobile controls on desktop and show desktop controls */
		@media (min-width: 769px) {
			.mobile-controls {
				display: none;
			}
			
			/* Hide fullscreen button on desktop */
			#fullscreenBtn,
			#fullscreenToggle {
				display: none !important;
			}
		}

		/* iOS Fullscreen Support */
		.ios-fullscreen {
			height: 100vh !important;
			overflow: hidden;
		}

		.ios-fullscreen body {
			height: 100vh !important;
			position: fixed;
			width: 100%;
			top: 0;
			left: 0;
		}

		/* Improved mobile viewport handling */
		@supports (-webkit-touch-callout: none) {
			/* iOS Safari */
			.ios-fullscreen .screen {
				height: 100vh;
				height: -webkit-fill-available;
			}
		}

		/* Hide desktop controls on mobile and ensure mobile controls are visible */
		@media (max-width: 768px) {
			.controls {
				display: none;
			}

			.mobile-controls {
				display: flex;
			}

			/* Compact mobile header */
			.compact-header {
				padding: 6px 8px;
				min-height: 35px;
			}

			.compact-btn {
				padding: 6px 8px;
				font-size: 0.9em;
				touch-action: manipulation;
				-webkit-tap-highlight-color: rgba(0, 255, 65, 0.3);
			}

			.compact-btn:active {
				transform: scale(0.95);
				background-color: rgba(0, 255, 65, 0.2);
			}

			/* Better mobile viewport handling */
			body {
				min-height: 100vh;
				min-height: 100dvh;
			}

			.screen {
				min-height: 100vh;
				min-height: 100dvh;
				display: flex;
				flex-direction: column;
			}

			.level-picker-content {
				flex: 1;
				display: flex;
				flex-direction: column;
				padding: 10px;
				max-height: 100vh;
				max-height: 100dvh;
				overflow: hidden;
			}

			.level-picker-title {
				font-size: 1.6em !important;
				margin: 10px 0 5px 0 !important;
			}

			.level-picker-content p {
				font-size: 1em !important;
				margin-bottom: 15px !important;
			}

			.level-grid {
				flex: 1;
				grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)) !important;
				gap: 8px !important;
				margin: 0 !important;
				max-height: calc(100vh - 180px) !important;
				max-height: calc(100dvh - 180px) !important;
				overflow-y: auto !important;
				-webkit-overflow-scrolling: touch !important;
			}

			.compact-stats {
				gap: 8px;
			}
			
			.stat-item {
				font-size: 0.75em;
			}
			
			.compact-status {
				padding: 6px 8px;
			}
			
			.level-info {
				font-size: 0.7em;
			}
		}

		/* Landscape orientation support */
		@media screen and (orientation: landscape) and (max-height: 500px) {
			.level-picker-screen {
				padding: 5px 0;
			}
			
			.level-picker-content {
				padding: 5px;
			}
			
			.level-picker-title {
				font-size: 1.3em !important;
				margin-bottom: 5px !important;
			}
			
			.level-grid {
				grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) !important;
				gap: 8px !important;
				max-height: 60vh !important;
				margin: 5px 0 !important;
			}
			
			.level-card {
				min-height: 70px !important;
				padding: 8px !important;
			}
			
			.level-card-number {
				font-size: 1.3em !important;
			}
			
			.level-card-title {
				font-size: 0.8em !important;
			}
			
			.level-card-desc {
				font-size: 0.7em !important;
			}
			
			/* Game screen landscape adjustments */
			.main-container {
				height: 100vh !important;
				height: calc(100dvh - 50px) !important;
				gap: 4px !important;
				padding: 4px !important;
			}
			
			.compact-header {
				padding: 4px 8px !important;
				min-height: 30px !important;
			}
			
			.compact-btn {
				padding: 4px 6px !important;
				font-size: 0.8em !important;
			}
			
			.compact-stats {
				gap: 6px !important;
			}
			
			.stat-item {
				font-size: 0.65em !important;
			}
			
			.compact-status {
				padding: 4px 8px !important;
			}
			
			.level-info {
				font-size: 0.6em !important;
			}
			
			.mobile-controls {
				padding: 4px !important;
				gap: 8px !important;
			}
			
			.mobile-btn {
				padding: 8px 12px !important;
				font-size: 0.9em !important;
			}
		}

		.controls {
			position: absolute;
			bottom: 10px;
			right: 10px;
			background: #333333;
			border: 3px solid #00ff41;
			padding: 10px;
			border-radius: 0;
			box-shadow: 
				3px 3px 0px #000000,
				6px 6px 0px rgba(0, 0, 0, 0.3);
			font-size: 0.8em;
			color: #00ff41;
			max-width: 200px;
			z-index: 10;
			text-shadow: 1px 1px 0px #000000;
			font-family: 'Courier New', monospace;
		}

		.pause-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			padding: 20px;
			box-sizing: border-box;
		}

		.pause-menu {
			background: #222222;
			background-image: 
				repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,255,65,.05) 10px, rgba(0,255,65,.05) 20px);
			border: 5px solid #00ff41;
			border-style: double;
			border-radius: 0;
			padding: 40px;
			box-shadow: 
				8px 8px 0px #000000,
				16px 16px 0px rgba(0, 0, 0, 0.7),
				inset 0 0 20px rgba(0, 255, 65, 0.1);
			text-align: center;
			min-width: 350px;
			max-width: 90vw;
			max-height: 90vh;
			overflow-y: auto;
			box-sizing: border-box;
			animation: pixelMenuSlide 0.4s ease-out;
		}

		.pause-title {
			font-size: 2em;
			font-weight: bold;
			color: #00ff41;
			margin-bottom: 30px;
			text-shadow: 2px 2px 0px #000000;
			font-family: 'Courier New', monospace;
			letter-spacing: 2px;
		}

		.pause-btn {
			display: block;
			width: 100%;
			padding: 15px 20px;
			margin: 15px 0;
			border: 3px solid #00ff41;
			border-radius: 0;
			font-size: 1.1em;
			font-weight: bold;
			font-family: 'Courier New', monospace;
			letter-spacing: 2px;
			cursor: pointer;
			transition: none;
			background: #333333;
			color: #00ff41;
			text-shadow: 2px 2px 0px #000000;
			box-shadow: 4px 4px 0px #000000;
		}

		.pause-btn.continue {
			background: #00ff41;
			color: #000000;
			border: 3px solid #66ff66;
			border-radius: 0;
			box-shadow: 3px 3px 0px #000000;
			text-shadow: none;
			font-family: 'Courier New', monospace;
			letter-spacing: 1px;
		}

		.pause-btn.continue:hover {
			background: #66ff66;
			transform: translate(-1px, -1px);
			box-shadow: 4px 4px 0px #000000;
		}

		.pause-btn.restart {
			background: #FF9800;
			color: white;
		}

		.pause-btn.restart:hover {
			background: #e68900;
		}

		.pause-btn.save {
			background: #2196F3;
			color: white;
		}

		.pause-btn.save:hover {
			background: #1976D2;
		}

		.pause-btn.exit {
			background: #f44336;
			color: white;
		}

		.pause-btn.exit:hover {
			background: #d32f2f;
		}

		.game-paused {
			opacity: 0.3;
		}

		/* Responsive Design - Mobile Tablet */
		@media (max-width: 768px) {
			.level-picker-content {
				padding: 10px;
			}

			.level-picker-title {
				font-size: 1.8em;
				margin-bottom: 10px;
				letter-spacing: 1px;
			}

			.level-grid {
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 10px;
				margin: 15px 0;
				max-height: 70vh;
				padding: 5px;
			}

			.level-card {
				padding: 12px;
				min-height: 100px;
				border-width: 3px;
				box-shadow: 
					3px 3px 0px #000000,
					6px 6px 0px rgba(0, 0, 0, 0.3);
			}

			.level-card:hover:not(.locked) {
				box-shadow: 
					4px 4px 0px #000000,
					8px 8px 0px rgba(0, 0, 0, 0.3);
			}

			.level-card-number {
				font-size: 1.8em;
			}

			.level-card-title {
				font-size: 1em;
				letter-spacing: 0.5px;
			}

			.level-card-desc {
				font-size: 0.8em;
			}

			.loading-content {
				padding: 20px;
				max-width: 90%;
				border-width: 3px;
				box-shadow: 
					4px 4px 0px #000000,
					8px 8px 0px rgba(0, 0, 0, 0.5);
			}

			.loading-title {
				font-size: 2.5em;
				letter-spacing: 2px;
			}

			.loading-subtitle {
				font-size: 1.1em;
				letter-spacing: 1px;
			}

			.loading-bar-container {
				height: 20px;
				border-width: 2px;
			}

			.main-container {
				padding: 5px;
				height: 100vh;
				gap: 8px;
			}

			.title {
				padding: 12px;
				min-height: 45px;
				border-width: 3px;
				box-shadow: 
					3px 3px 0px #000000,
					6px 6px 0px rgba(0, 0, 0, 0.3);
			}

			.title h1 {
				font-size: 1.6em;
				letter-spacing: 1px;
			}

			.title .pause-btn {
				position: absolute;
				right: 8px;
				top: 50%;
				transform: translateY(-50%);
				padding: 6px 10px;
				font-size: 0.7em;
				border-width: 2px;
				box-shadow: 2px 2px 0px #000000;
				letter-spacing: 1px;
			}

			.game-stats {
				gap: 15px;
				padding: 12px;
				border-width: 3px;
				box-shadow: 
					3px 3px 0px #000000,
					6px 6px 0px rgba(0, 0, 0, 0.3);
			}

			.game-container {
				padding: 8px;
				border-width: 3px;
				box-shadow: 
					3px 3px 0px #000000,
					6px 6px 0px rgba(0, 0, 0, 0.3);
			}

			.game-text {
				padding: 8px;
				min-height: 35px;
				border-width: 3px;
				box-shadow: 
					3px 3px 0px #000000,
					6px 6px 0px rgba(0, 0, 0, 0.3);
				font-size: 1em;
			}

			#game {
				grid-template-columns: repeat(10, 35px);
				grid-template-rows: repeat(10, 28px);
			}

			.controls {
				bottom: 8px;
				right: 8px;
				padding: 8px;
				font-size: 0.75em;
				border-width: 2px;
				box-shadow: 
					2px 2px 0px #000000,
					4px 4px 0px rgba(0, 0, 0, 0.3);
				max-width: 180px;
			}
		}

		/* Mobile Phone Optimization */
		@media (max-width: 480px) {
			.level-picker-content {
				padding: 8px;
			}

			.level-picker-title {
				font-size: 1.5em;
				letter-spacing: 1px;
				margin-bottom: 8px;
			}

			.level-grid {
				grid-template-columns: 1fr 1fr;
				gap: 8px;
				margin: 10px 0;
				max-height: 75vh;
				max-height: 75dvh; /* Dynamic viewport height */
				padding: 3px;
				-webkit-overflow-scrolling: touch;
				overflow-y: auto;
			}

			.level-card {
				padding: 10px;
				min-height: 90px;
				border-width: 2px;
				box-shadow: 
					2px 2px 0px #000000,
					4px 4px 0px rgba(0, 0, 0, 0.3);
				-webkit-tap-highlight-color: rgba(0, 255, 65, 0.3);
				touch-action: manipulation;
				user-select: none;
				-webkit-user-select: none;
			}

			.level-card:hover:not(.locked) {
				transform: translate(-1px, -1px);
				box-shadow: 
					3px 3px 0px #000000,
					6px 6px 0px rgba(0, 0, 0, 0.3);
			}

			.level-card-number {
				font-size: 1.6em;
			}

			.level-card-title {
				font-size: 0.9em;
				letter-spacing: 0.5px;
			}

			.level-card-desc {
				font-size: 0.75em;
			}

			.loading-content {
				padding: 15px;
				border-width: 2px;
				box-shadow: 
					3px 3px 0px #000000,
					6px 6px 0px rgba(0, 0, 0, 0.5);
			}

			.loading-title {
				font-size: 2em;
				letter-spacing: 1px;
			}

			.loading-subtitle {
				font-size: 0.9em;
				letter-spacing: 1px;
			}

			.main-container {
				padding: 3px;
				gap: 6px;
				height: 100vh;
				height: calc(100dvh - 80px); /* Account for mobile controls */
				padding-bottom: max(3px, env(safe-area-inset-bottom));
				min-height: 0;
			}

			.title {
				padding: 10px;
				min-height: 40px;
			}

			.title h1 {
				font-size: 1.4em;
				letter-spacing: 1px;
			}

			.title .pause-btn {
				padding: 8px 12px;
				font-size: 0.7em;
				right: 5px;
				min-width: auto;
				-webkit-tap-highlight-color: rgba(255, 255, 255, 0.2);
				touch-action: manipulation;
			}

			.game-stats {
				gap: 10px;
				padding: 10px;
			}

			.stat-value {
				font-size: 1.5em;
			}

			#game {
				grid-template-columns: repeat(10, min(28px, 8vw));
				grid-template-rows: repeat(10, min(23px, 6vw));
				border-width: 3px;
				max-width: 100%;
				width: fit-content;
				height: fit-content;
				overflow: visible;
				gap: 1px;
				justify-self: center;
				align-self: center;
			}

			.cell {
				font-size: 9px;
				border-width: 1px;
			}

			.game-text {
				padding: 6px;
				min-height: 30px;
				font-size: 0.9em;
			}

			.controls {
				bottom: 5px;
				right: 5px;
				padding: 6px;
				font-size: 0.65em;
				max-width: 150px;
				border-width: 2px;
				box-shadow: 
					2px 2px 0px #000000,
					4px 4px 0px rgba(0, 0, 0, 0.3);
			}

			.pause-menu {
				padding: 20px;
				min-width: 280px;
				border-width: 4px;
				box-shadow: 
					6px 6px 0px #000000,
					12px 12px 0px rgba(0, 0, 0, 0.7);
			}

			.pause-title {
				font-size: 1.4em;
				letter-spacing: 1px;
				margin-bottom: 20px;
			}

			.pause-btn {
				padding: 12px 15px;
				font-size: 0.9em;
				margin: 12px 0;
				letter-spacing: 1px;
				border-width: 2px;
				box-shadow: 3px 3px 0px #000000;
			}

			.pause-btn:hover {
				transform: translate(-1px, -1px);
				box-shadow: 4px 4px 0px #000000;
			}
		}

		@keyframes pixelGlow {
			0% { filter: brightness(1) drop-shadow(0 0 0px #66ff66); }
			50% { filter: brightness(1.5) drop-shadow(0 0 8px #66ff66); }
			100% { filter: brightness(1) drop-shadow(0 0 0px #66ff66); }
		}

		@keyframes pixelShake {
			0%, 100% { transform: translateX(0); }
			10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
			20%, 40%, 60%, 80% { transform: translateX(2px); }
		}

		@keyframes pixelFlicker {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.8; }
			75% { opacity: 1; }
			85% { opacity: 0.9; }
		}

		@keyframes pixelScan {
			0% { background-position: -100px 0; }
			100% { background-position: 100px 0; }
		}

		@keyframes pixelBlink {
			0%, 70% { opacity: 1; }
			85%, 100% { opacity: 0.3; }
		}

		@keyframes pixelOverlay {
			0% { opacity: 0; }
			100% { opacity: 1; }
		}

		@keyframes pixelMenuSlide {
			0% { 
				transform: scale(0.8) translate(10px, 10px);
				opacity: 0;
			}
			100% { 
				transform: scale(1) translate(0, 0);
				opacity: 1;
			}
		}
	</style>
</head>

<body>
	<!-- Loading Screen -->
	<div class="screen loading-screen active" id="loadingScreen">
		<div class="loading-content">
			<div class="loading-title">üßÆ</div>
			<h1 class="loading-title">MathDrop Academy</h1>
			<div class="loading-subtitle">Educational Math Adventure for All Ages</div>

			<div class="loading-bar-container">
				<div class="loading-bar" id="loadingBar"></div>
			</div>

			<div class="loading-text" id="loadingText">Initializing game engine...</div>
			
			<!-- Fullscreen Button - hidden until loading complete -->
			<button class="pause-btn continue" id="fullscreenBtn" style="display: none; margin-top: 20px;">
				üì± Enter Fullscreen
			</button>
		</div>
	</div>

	<!-- Level Picker Screen -->
	<div class="screen level-picker-screen" id="levelPickerScreen">
		<div class="level-picker-content">
			<h1 class="level-picker-title">üéì Choose Your Challenge</h1>
			<p style="font-size: 1.2em; margin-bottom: 30px;">Select a level to begin your mathematical journey</p>

			<div class="level-grid" id="levelGrid">
				<!-- Level cards will be generated here -->
			</div>

			<button class="pause-btn continue" style="margin-top: 30px;" onclick="showLoadingScreen()">üîÑ Reload
				Game</button>
		</div>
	</div>

	<!-- Game Screen -->
	<div class="screen game-screen" id="gameScreen">
		<div class="main-container">
			<!-- Compact Header with combined title and stats -->
			<div class="compact-header">
				<div class="header-left">
					<button class="compact-btn" id="levelPickerBtn">üìö</button>
					<button class="compact-btn" id="pauseBtn">‚è∏Ô∏è</button>
				</div>
				<div class="header-center">
					<div class="compact-stats">
						<span class="stat-item">Score: <strong id="score">0</strong></span>
						<span class="stat-item">Level: <strong id="level">0</strong></span>
						<span class="stat-item">‚úì<strong id="correct">0</strong> ‚úó<strong id="wrong">0</strong></span>
					</div>
				</div>
				<div class="header-right">
					<button class="compact-btn" id="fullscreenToggle">üî≤</button>
				</div>
			</div>

			<!-- Game Board - Main Focus -->
			<div class="game-container">
				<div id="game"></div>
			</div>

			<!-- Compact Status Bar -->
			<div class="compact-status">
				<div id="status" class="status-default">Position the falling card over the correct answer!</div>
				<div class="level-info" id="levelDescription">Basic addition problems</div>
			</div>
		</div>

		<!-- Mobile Control Buttons -->
		<div class="mobile-controls">
			<button class="mobile-btn" id="leftBtn">‚Üê</button>
			<button class="mobile-btn" id="dropBtn">DROP</button>
			<button class="mobile-btn" id="rightBtn">‚Üí</button>
		</div>
	</div>

	<!-- Pause Menu Overlay -->
	<div class="pause-overlay" id="pauseOverlay">
		<div class="pause-menu">
			<div class="pause-title">‚è∏Ô∏è Game Paused</div>
			<button class="pause-btn continue" id="continueBtn">‚ñ∂Ô∏è Continue Game</button>
			<button class="pause-btn restart" id="restartBtn">üîÑ Restart Level</button>
			<button class="pause-btn save" id="saveBtn">üíæ Save Progress</button>
			<button class="pause-btn exit" id="exitBtn">üö™ Exit to Level Select</button>
		</div>
	</div>
	<script>
		/**
		 * MathDrop Academy - Version 1.0.0
		 * Educational math game with progressive difficulty for all ages
		 * 
		 * Game Flow:
		 * 1. Loading Screen - Shows progress bar while initializing
		 * 2. Level Picker - Beautiful card interface for level selection
		 * 3. Game Screen - Main gameplay with falling math cards
		 * 4. Pause Menu - In-game menu with save/restart options
		 * 
		 * Educational Progression (17 Levels):
		 * Foundational Arithmetic (0-4): Addition, Subtraction, Multiplication, Division, Mixed
		 * Number Concepts (5-8): Fractions, Decimals, Percentages, Powers & Roots
		 * Pre-Algebra (9-12): Patterns, Basic Algebra, Inequalities, Coordinate Geometry
		 * Advanced Math (13-16): Logic & Sets, Statistics, Trigonometry, Mathematical Constants
		 * 
		 * Technical Features:
		 * - Multi-screen game architecture
		 * - LocalStorage progress persistence
		 * - Dynamic question generation for 17 levels
		 * - Responsive design for all devices
		 * - Progressive difficulty unlocking system
		 * 
		 * @name MathDrop Academy
		 * @version 1.0.0  
		 * @date 2025
		 */

		// Game State Management
		let currentScreen = 'loading';
		let loadingProgress = 0;

		const gridW = 10, gridH = 10;
		const game = document.getElementById("game");
		const status = document.getElementById("status");
		const scoreEl = document.getElementById("score");
		const correctEl = document.getElementById("correct");
		const wrongEl = document.getElementById("wrong");
		const levelEl = document.getElementById("level");

		let grid = Array.from({ length: gridH }, () => Array(gridW).fill(""));
		let falling = null, fy = 0, fx = 5, interval;
		let isPaused = false;

		// Game state with localStorage support
		let gameState = {
			score: 0,
			correct: 0,
			wrong: 0,
			level: 0,
			unlockedLevels: 1, // How many levels player has unlocked
			highestScore: 0
		};

		// LocalStorage functions
		function saveGameState() {
			localStorage.setItem('mathFlashcardsGame', JSON.stringify({
				unlockedLevels: gameState.unlockedLevels,
				highestScore: gameState.highestScore,
				currentLevel: gameState.level
			}));
		}

		function loadGameState() {
			const saved = localStorage.getItem('mathFlashcardsGame');
			if (saved) {
				const data = JSON.parse(saved);
				gameState.unlockedLevels = data.unlockedLevels || 1;
				gameState.highestScore = data.highestScore || 0;
				gameState.level = data.currentLevel || 0;
			}
		}

		// Level definitions
		const LEVELS = {
			0: { name: 'Addition', symbol: '+', description: 'Basic addition problems' },
			1: { name: 'Subtraction', symbol: '-', description: 'Basic subtraction problems' },
			2: { name: 'Multiplication', symbol: '√ó', description: 'Basic multiplication problems' },
			3: { name: 'Division', symbol: '√∑', description: 'Basic division problems' },
			4: { name: 'Mixed', symbol: '?', description: 'All operations mixed together' },
			5: { name: 'Fractions', symbol: '¬Ω', description: 'Working with parts of whole numbers' },
			6: { name: 'Decimals', symbol: '.', description: 'Decimal point arithmetic' },
			7: { name: 'Percentages', symbol: '%', description: 'Understanding proportions and percentages' },
			8: { name: 'Powers & Roots', symbol: '¬≤‚àö', description: 'Squares, cubes, and square roots' },
			9: { name: 'Number Patterns', symbol: '...', description: 'Recognizing mathematical sequences' },
			10: { name: 'Basic Algebra', symbol: 'x', description: 'Solving for unknown variables' },
			11: { name: 'Inequalities', symbol: '<>', description: 'Greater than and less than relationships' },
			12: { name: 'Coordinate Geometry', symbol: '(x,y)', description: 'Working with points and lines' },
			13: { name: 'Logic & Sets', symbol: '‚à©‚à™', description: 'Mathematical reasoning and set theory' },
			14: { name: 'Statistics & Probability', symbol: 'üìä', description: 'Data analysis and chance' },
			15: { name: 'Trigonometry', symbol: 'sin', description: 'Triangles and circular functions' },
			16: { name: 'Mathematical Constants', symbol: 'œÄ', description: 'Special numbers in mathematics' }
		};

		// Get all available answers currently on the grid
		function getAvailableAnswers() {
			let availableAnswers = new Set();
			for (let y = 0; y < gridH; y++) {
				for (let x = 0; x < gridW; x++) {
					if (grid[y][x] !== "") {
						availableAnswers.add(grid[y][x]);
					}
				}
			}
			return Array.from(availableAnswers);
		}

		// Level 0: Addition only - generate questions with answers that exist on grid
		function generateLevel0Question() {
			const availableAnswers = getAvailableAnswers();

			// If no numbers available, something went wrong - fallback
			if (availableAnswers.length === 0) {
				return { q: "0+0", a: "0" };
			}

			// Pick a random available answer
			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate an addition problem that equals this answer
			let num1, num2;
			if (targetAnswer === 0) {
				// Special case for 0
				const options = [[0, 0]];
				const choice = options[Math.floor(Math.random() * options.length)];
				num1 = choice[0];
				num2 = choice[1];
			} else {
				// Generate two numbers that add up to targetAnswer
				num1 = Math.floor(Math.random() * (targetAnswer + 1));
				num2 = targetAnswer - num1;
			}

			return {
				q: `${num1}+${num2}`,
				a: targetAnswer.toString()
			};
		}

		// Level 1: Subtraction only - generate questions with answers that exist on grid
		function generateLevel1Question() {
			const availableAnswers = getAvailableAnswers();

			// If no numbers available, something went wrong - fallback
			if (availableAnswers.length === 0) {
				return { q: "0-0", a: "0" };
			}

			// Pick a random available answer
			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate a subtraction problem that equals this answer
			let num1, num2;
			if (targetAnswer === 0) {
				// For 0, we can do any number minus itself
				num1 = Math.floor(Math.random() * 10);
				num2 = num1;
			} else {
				// Generate two numbers where num1 - num2 = targetAnswer
				num2 = Math.floor(Math.random() * (10 - targetAnswer)); // ensure num1 won't exceed 9
				num1 = targetAnswer + num2;
			}

			return {
				q: `${num1}-${num2}`,
				a: targetAnswer.toString()
			};
		}

		// Level 2: Multiplication - generate questions with answers that exist on grid
		function generateLevel2Question() {
			const availableAnswers = getAvailableAnswers();

			if (availableAnswers.length === 0) {
				return { q: "0√ó0", a: "0" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			let num1, num2;
			if (targetAnswer === 0) {
				// For 0: any number √ó 0
				num1 = Math.floor(Math.random() * 10);
				num2 = 0;
			} else if (targetAnswer === 1) {
				// For 1: 1 √ó 1
				num1 = 1;
				num2 = 1;
			} else {
				// Find factors of targetAnswer
				const factors = [];
				for (let i = 1; i <= Math.min(targetAnswer, 9); i++) {
					if (targetAnswer % i === 0 && targetAnswer / i <= 9) {
						factors.push([i, targetAnswer / i]);
					}
				}

				if (factors.length > 0) {
					const choice = factors[Math.floor(Math.random() * factors.length)];
					num1 = choice[0];
					num2 = choice[1];
				} else {
					// Fallback: use 1 √ó targetAnswer if targetAnswer <= 9
					num1 = 1;
					num2 = targetAnswer <= 9 ? targetAnswer : 1;
				}
			}

			return {
				q: `${num1}√ó${num2}`,
				a: targetAnswer.toString()
			};
		}

		// Level 3: Division - generate questions with answers that exist on grid
		function generateLevel3Question() {
			const availableAnswers = getAvailableAnswers();

			if (availableAnswers.length === 0) {
				return { q: "0√∑1", a: "0" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			let num1, num2;
			if (targetAnswer === 0) {
				// For 0: 0 √∑ any number
				num1 = 0;
				num2 = Math.floor(Math.random() * 9) + 1; // 1-9
			} else {
				// Generate division: num1 √∑ num2 = targetAnswer
				num2 = Math.floor(Math.random() * 9) + 1; // 1-9 (avoid division by zero)
				num1 = targetAnswer * num2;

				// Keep num1 reasonable (‚â§ 81 for single digit tables)
				if (num1 > 81) {
					num2 = Math.floor(81 / targetAnswer);
					num1 = targetAnswer * num2;
				}
			}

			return {
				q: `${num1}√∑${num2}`,
				a: targetAnswer.toString()
			};
		}

		// Level 4: Mixed Operations - randomly choose operation
		function generateLevel4Question() {
			const operations = [
				() => generateLevel0Question(),
				() => generateLevel1Question(),
				() => generateLevel2Question(),
				() => generateLevel3Question()
			];

			const randomOp = operations[Math.floor(Math.random() * operations.length)];
			return randomOp();
		}

		// Level 5: Fractions
		function generateLevel5Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "1/2+1/2", a: "1" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate simple fraction problems that equal whole numbers
			const fractionProblems = [
				{ q: "1/2+1/2", a: 1 }, { q: "3/4+1/4", a: 1 }, { q: "2/3+1/3", a: 1 },
				{ q: "1/4+3/4", a: 1 }, { q: "1/2+3/2", a: 2 }, { q: "5/2-1/2", a: 2 },
				{ q: "3/2+3/2", a: 3 }, { q: "7/2-1/2", a: 3 }, { q: "2/1+2/1", a: 4 },
				{ q: "9/2-1/2", a: 4 }, { q: "3/1+2/1", a: 5 }, { q: "11/2-1/2", a: 5 },
				{ q: "4/1+2/1", a: 6 }, { q: "13/2-1/2", a: 6 }, { q: "5/1+2/1", a: 7 },
				{ q: "15/2-1/2", a: 7 }, { q: "6/1+2/1", a: 8 }, { q: "17/2-1/2", a: 8 },
				{ q: "7/1+2/1", a: 9 }, { q: "19/2-1/2", a: 9 }
			];

			const validProblems = fractionProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "1/2+1/2", a: "1" };
		}

		// Level 6: Decimals
		function generateLevel6Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "0.5+0.5", a: "1" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate decimal problems that equal whole numbers
			const decimalProblems = [
				{ q: "0.5+0.5", a: 1 }, { q: "1.2+0.8", a: 2 }, { q: "1.5+1.5", a: 3 },
				{ q: "2.2+1.8", a: 4 }, { q: "2.5+2.5", a: 5 }, { q: "3.2+2.8", a: 6 },
				{ q: "3.5+3.5", a: 7 }, { q: "4.2+3.8", a: 8 }, { q: "4.5+4.5", a: 9 },
				{ q: "1.0-0.0", a: 1 }, { q: "2.0-0.0", a: 2 }, { q: "3.0-0.0", a: 3 },
				{ q: "4.0-0.0", a: 4 }, { q: "5.0-0.0", a: 5 }, { q: "6.0-0.0", a: 6 },
				{ q: "7.0-0.0", a: 7 }, { q: "8.0-0.0", a: 8 }, { q: "9.0-0.0", a: 9 }
			];

			const validProblems = decimalProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "0.5+0.5", a: "1" };
		}

		// Level 7: Percentages
		function generateLevel7Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "50% of 2", a: "1" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate percentage problems
			const percentageProblems = [
				{ q: "50% of 2", a: 1 }, { q: "25% of 4", a: 1 }, { q: "100% of 1", a: 1 },
				{ q: "50% of 4", a: 2 }, { q: "25% of 8", a: 2 }, { q: "100% of 2", a: 2 },
				{ q: "50% of 6", a: 3 }, { q: "25% of 12", a: 3 }, { q: "100% of 3", a: 3 },
				{ q: "50% of 8", a: 4 }, { q: "25% of 16", a: 4 }, { q: "100% of 4", a: 4 },
				{ q: "50% of 10", a: 5 }, { q: "25% of 20", a: 5 }, { q: "100% of 5", a: 5 },
				{ q: "50% of 12", a: 6 }, { q: "25% of 24", a: 6 }, { q: "100% of 6", a: 6 },
				{ q: "50% of 14", a: 7 }, { q: "25% of 28", a: 7 }, { q: "100% of 7", a: 7 },
				{ q: "50% of 16", a: 8 }, { q: "25% of 32", a: 8 }, { q: "100% of 8", a: 8 },
				{ q: "50% of 18", a: 9 }, { q: "25% of 36", a: 9 }, { q: "100% of 9", a: 9 }
			];

			const validProblems = percentageProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "50% of 2", a: "1" };
		}

		// Level 8: Powers & Roots
		function generateLevel8Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "1¬≤", a: "1" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate power and root problems
			const powerProblems = [
				{ q: "1¬≤", a: 1 }, { q: "‚àö1", a: 1 }, { q: "1¬≥", a: 1 },
				{ q: "‚àö4", a: 2 }, { q: "2¬π", a: 2 }, { q: "‚àõ8", a: 2 },
				{ q: "‚àö9", a: 3 }, { q: "3¬π", a: 3 }, { q: "‚àõ27", a: 3 },
				{ q: "2¬≤", a: 4 }, { q: "‚àö16", a: 4 }, { q: "4¬π", a: 4 },
				{ q: "‚àö25", a: 5 }, { q: "5¬π", a: 5 }, { q: "‚àõ125", a: 5 },
				{ q: "‚àö36", a: 6 }, { q: "6¬π", a: 6 }, { q: "2√ó3", a: 6 },
				{ q: "‚àö49", a: 7 }, { q: "7¬π", a: 7 }, { q: "‚àõ343", a: 7 },
				{ q: "‚àö64", a: 8 }, { q: "2¬≥", a: 8 }, { q: "8¬π", a: 8 },
				{ q: "3¬≤", a: 9 }, { q: "‚àö81", a: 9 }, { q: "9¬π", a: 9 }
			];

			const validProblems = powerProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "1¬≤", a: "1" };
		}

		// Level 9: Number Patterns
		function generateLevel9Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "1,2,3,?", a: "4" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate pattern problems
			const patterns = [
				{ q: "0,1,2,?", a: 3 }, { q: "1,2,3,?", a: 4 }, { q: "2,3,4,?", a: 5 },
				{ q: "3,4,5,?", a: 6 }, { q: "4,5,6,?", a: 7 }, { q: "5,6,7,?", a: 8 },
				{ q: "6,7,8,?", a: 9 }, { q: "2,4,6,?", a: 8 }, { q: "1,3,5,?", a: 7 },
				{ q: "0,2,4,?", a: 6 }, { q: "1,4,7,?", a: 10 % 10 }, { q: "Fib:1,1,2,?", a: 3 },
				{ q: "Fib:1,2,3,?", a: 5 }, { q: "Fib:2,3,5,?", a: 8 }, { q: "√ó2: 1,2,?", a: 4 },
				{ q: "√ó2: 2,4,?", a: 8 }, { q: "Sq: 1,4,?", a: 9 }
			];

			const validProblems = patterns.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "1,2,3,?", a: "4" };
		}

		// Level 10: Basic Algebra
		function generateLevel10Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "x+1=2, x=?", a: "1" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate algebra problems
			const algebraProblems = [
				{ q: "x+0=0, x=?", a: 0 }, { q: "x-0=0, x=?", a: 0 }, { q: "x+1=1, x=?", a: 0 },
				{ q: "x+1=2, x=?", a: 1 }, { q: "x-1=0, x=?", a: 1 }, { q: "2x=2, x=?", a: 1 },
				{ q: "x+1=3, x=?", a: 2 }, { q: "x-1=1, x=?", a: 2 }, { q: "2x=4, x=?", a: 2 },
				{ q: "x+1=4, x=?", a: 3 }, { q: "x-1=2, x=?", a: 3 }, { q: "3x=9, x=?", a: 3 },
				{ q: "x+1=5, x=?", a: 4 }, { q: "x-1=3, x=?", a: 4 }, { q: "2x=8, x=?", a: 4 },
				{ q: "x+1=6, x=?", a: 5 }, { q: "x-1=4, x=?", a: 5 }, { q: "5x=25, x=?", a: 5 },
				{ q: "x+1=7, x=?", a: 6 }, { q: "x-1=5, x=?", a: 6 }, { q: "2x=12, x=?", a: 6 },
				{ q: "x+1=8, x=?", a: 7 }, { q: "x-1=6, x=?", a: 7 }, { q: "7x=49, x=?", a: 7 },
				{ q: "x+1=9, x=?", a: 8 }, { q: "x-1=7, x=?", a: 8 }, { q: "2x=16, x=?", a: 8 },
				{ q: "x+1=10, x=?", a: 9 }, { q: "x-1=8, x=?", a: 9 }, { q: "3x=27, x=?", a: 9 }
			];

			const validProblems = algebraProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "x+1=2, x=?", a: "1" };
		}

		// Level 11: Inequalities
		function generateLevel11Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "x>0, min x=?", a: "1" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate inequality problems
			const inequalityProblems = [
				{ q: "x‚â•0, min x=?", a: 0 }, { q: "x>-1, min x=?", a: 0 }, { q: "x‚â§0, max x=?", a: 0 },
				{ q: "x>0, min x=?", a: 1 }, { q: "x‚â•1, min x=?", a: 1 }, { q: "x<2, max x=?", a: 1 },
				{ q: "x>1, min x=?", a: 2 }, { q: "x‚â•2, min x=?", a: 2 }, { q: "x<3, max x=?", a: 2 },
				{ q: "x>2, min x=?", a: 3 }, { q: "x‚â•3, min x=?", a: 3 }, { q: "x<4, max x=?", a: 3 },
				{ q: "x>3, min x=?", a: 4 }, { q: "x‚â•4, min x=?", a: 4 }, { q: "x<5, max x=?", a: 4 },
				{ q: "x>4, min x=?", a: 5 }, { q: "x‚â•5, min x=?", a: 5 }, { q: "x<6, max x=?", a: 5 },
				{ q: "x>5, min x=?", a: 6 }, { q: "x‚â•6, min x=?", a: 6 }, { q: "x<7, max x=?", a: 6 },
				{ q: "x>6, min x=?", a: 7 }, { q: "x‚â•7, min x=?", a: 7 }, { q: "x<8, max x=?", a: 7 },
				{ q: "x>7, min x=?", a: 8 }, { q: "x‚â•8, min x=?", a: 8 }, { q: "x<9, max x=?", a: 8 },
				{ q: "x>8, min x=?", a: 9 }, { q: "x‚â•9, min x=?", a: 9 }, { q: "x<10, max x=?", a: 9 }
			];

			const validProblems = inequalityProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "x>0, min x=?", a: "1" };
		}

		// Level 12: Coordinate Geometry
		function generateLevel12Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "d(0,0)-(1,0)", a: "1" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate coordinate geometry problems
			const coordProblems = [
				{ q: "d(0,0)-(0,0)", a: 0 }, { q: "slope(0,0)-(0,1)", a: 0 },
				{ q: "d(0,0)-(1,0)", a: 1 }, { q: "d(0,0)-(0,1)", a: 1 },
				{ q: "d(0,0)-(2,0)", a: 2 }, { q: "d(0,0)-(0,2)", a: 2 },
				{ q: "d(0,0)-(3,0)", a: 3 }, { q: "d(0,0)-(0,3)", a: 3 },
				{ q: "d(0,0)-(4,0)", a: 4 }, { q: "d(0,0)-(0,4)", a: 4 },
				{ q: "d(0,0)-(5,0)", a: 5 }, { q: "d(0,0)-(0,5)", a: 5 },
				{ q: "d(0,0)-(6,0)", a: 6 }, { q: "d(0,0)-(0,6)", a: 6 },
				{ q: "d(0,0)-(7,0)", a: 7 }, { q: "d(0,0)-(0,7)", a: 7 },
				{ q: "d(0,0)-(8,0)", a: 8 }, { q: "d(0,0)-(0,8)", a: 8 },
				{ q: "d(0,0)-(9,0)", a: 9 }, { q: "d(0,0)-(0,9)", a: 9 }
			];

			const validProblems = coordProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "d(0,0)-(1,0)", a: "1" };
		}

		// Level 13: Logic & Sets
		function generateLevel13Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "{1}‚à™{0}=?", a: "2" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate logic and set problems (count of elements)
			const logicProblems = [
				{ q: "{}‚à™{}=?", a: 0 }, { q: "T‚àßF=?", a: 0 }, { q: "F‚à®F=?", a: 0 },
				{ q: "{1}=?", a: 1 }, { q: "T‚à®F=?", a: 1 }, { q: "¬¨F=?", a: 1 },
				{ q: "{1,2}=?", a: 2 }, { q: "{1}‚à™{2}=?", a: 2 }, { q: "T‚à®T=?", a: 1 },
				{ q: "{1,2,3}=?", a: 3 }, { q: "{1,2}‚à™{3}=?", a: 3 },
				{ q: "{1,2,3,4}=?", a: 4 }, { q: "{1,2}‚à™{3,4}=?", a: 4 },
				{ q: "{1,2,3,4,5}=?", a: 5 }, { q: "{0,1,2,3,4}=?", a: 5 },
				{ q: "{0,1,2,3,4,5}=?", a: 6 }, { q: "{1,2,3}‚à™{4,5,6}=?", a: 6 },
				{ q: "{0,1,2,3,4,5,6}=?", a: 7 },
				{ q: "{0,1,2,3,4,5,6,7}=?", a: 8 },
				{ q: "{0,1,2,3,4,5,6,7,8}=?", a: 9 }
			];

			const validProblems = logicProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "{1}‚à™{0}=?", a: "2" };
		}

		// Level 14: Statistics & Probability
		function generateLevel14Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "mean(1,1)", a: "1" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate statistics problems
			const statsProblems = [
				{ q: "mean(0,0)", a: 0 }, { q: "mode(0,0,0)", a: 0 },
				{ q: "mean(1,1)", a: 1 }, { q: "median(0,1,2)", a: 1 },
				{ q: "mean(2,2)", a: 2 }, { q: "median(1,2,3)", a: 2 },
				{ q: "mean(3,3)", a: 3 }, { q: "median(2,3,4)", a: 3 },
				{ q: "mean(4,4)", a: 4 }, { q: "median(3,4,5)", a: 4 },
				{ q: "mean(5,5)", a: 5 }, { q: "median(4,5,6)", a: 5 },
				{ q: "mean(6,6)", a: 6 }, { q: "median(5,6,7)", a: 6 },
				{ q: "mean(7,7)", a: 7 }, { q: "median(6,7,8)", a: 7 },
				{ q: "mean(8,8)", a: 8 }, { q: "median(7,8,9)", a: 8 },
				{ q: "mean(9,9)", a: 9 }, { q: "median(8,9,10)", a: 9 }
			];

			const validProblems = statsProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "mean(1,1)", a: "1" };
		}

		// Level 15: Trigonometry
		function generateLevel15Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "sin(90¬∞)", a: "1" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate trigonometry problems (rounded to integers)
			const trigProblems = [
				{ q: "sin(0¬∞)", a: 0 }, { q: "cos(90¬∞)", a: 0 }, { q: "tan(0¬∞)", a: 0 },
				{ q: "sin(90¬∞)", a: 1 }, { q: "cos(0¬∞)", a: 1 }, { q: "tan(45¬∞)", a: 1 },
				{ q: "sin(30¬∞)√ó4", a: 2 }, { q: "cos(60¬∞)√ó4", a: 2 },
				{ q: "sin(60¬∞)√ó3.5", a: 3 }, { q: "cos(30¬∞)√ó3.5", a: 3 },
				{ q: "2√ósin(90¬∞)√ó2", a: 4 }, { q: "2√ócos(0¬∞)√ó2", a: 4 },
				{ q: "sin(90¬∞)√ó5", a: 5 }, { q: "cos(0¬∞)√ó5", a: 5 },
				{ q: "sin(90¬∞)√ó6", a: 6 }, { q: "cos(0¬∞)√ó6", a: 6 },
				{ q: "sin(90¬∞)√ó7", a: 7 }, { q: "cos(0¬∞)√ó7", a: 7 },
				{ q: "sin(90¬∞)√ó8", a: 8 }, { q: "cos(0¬∞)√ó8", a: 8 },
				{ q: "sin(90¬∞)√ó9", a: 9 }, { q: "cos(0¬∞)√ó9", a: 9 }
			];

			const validProblems = trigProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "sin(90¬∞)", a: "1" };
		}

		// Level 16: Mathematical Constants
		function generateLevel16Question() {
			const availableAnswers = getAvailableAnswers();
			if (availableAnswers.length === 0) {
				return { q: "‚åäœÄ‚åã", a: "3" };
			}

			const targetAnswer = parseInt(availableAnswers[Math.floor(Math.random() * availableAnswers.length)]);

			// Generate problems involving mathematical constants
			const constantProblems = [
				{ q: "‚åäe-e‚åã", a: 0 }, { q: "‚åäœÄ-œÄ‚åã", a: 0 },
				{ q: "‚åäe/e‚åã", a: 1 }, { q: "‚åäœÄ/œÄ‚åã", a: 1 },
				{ q: "‚åäe‚åã", a: 2 }, { q: "‚åä2.718‚åã", a: 2 },
				{ q: "‚åäœÄ‚åã", a: 3 }, { q: "‚åä3.14159‚åã", a: 3 },
				{ q: "‚åäœÄ+1‚åã", a: 4 }, { q: "‚åäe+2‚åã", a: 4 },
				{ q: "‚åäœÄ+2‚åã", a: 5 }, { q: "‚åäe+3‚åã", a: 5 },
				{ q: "‚åä2œÄ‚åã", a: 6 }, { q: "‚åäœÄ+3‚åã", a: 6 },
				{ q: "‚åä2œÄ+1‚åã", a: 7 }, { q: "‚åäœÄ+4‚åã", a: 7 },
				{ q: "‚åä2œÄ+2‚åã", a: 8 }, { q: "‚åäœÄ+5‚åã", a: 8 },
				{ q: "‚åä3œÄ‚åã", a: 9 }, { q: "‚åäœÄ+6‚åã", a: 9 }
			];

			const validProblems = constantProblems.filter(p => p.a === targetAnswer);
			if (validProblems.length > 0) {
				const chosen = validProblems[Math.floor(Math.random() * validProblems.length)];
				return { q: chosen.q, a: chosen.a.toString() };
			}

			return { q: "‚åäœÄ‚åã", a: "3" };
		}

		function updateStats() {
			// Update score, level, correct/wrong counts
			const score = document.getElementById("score");
			const correct = document.getElementById("correct");
			const wrong = document.getElementById("wrong");
			const level = document.getElementById("level");
			
			if (score) score.textContent = gameState.score;
			if (correct) correct.textContent = gameState.correct;
			if (wrong) wrong.textContent = gameState.wrong;
			if (level) level.textContent = gameState.level;

			// Update high score
			if (gameState.score > gameState.highestScore) {
				gameState.highestScore = gameState.score;
			}

			// Update level description
			const levelDesc = document.getElementById('levelDescription');
			const currentLevel = LEVELS[gameState.level];
			if (currentLevel && levelDesc) {
				levelDesc.textContent = currentLevel.description;
			}

			// Save progress
			saveGameState();
		}

		// Self-analysis and test function
		function runSelfAnalysis() {
			console.log("üßÆ MathDrop Academy - Self Analysis Starting...");
			
			const tests = {
				domElements: [],
				functions: [],
				gameLogic: [],
				mobile: []
			};

			// Test 1: Check critical DOM elements
			const criticalElements = [
				'loadingScreen', 'levelPickerScreen', 'gameScreen',
				'score', 'level', 'correct', 'wrong', 'levelDescription',
				'game', 'status', 'leftBtn', 'rightBtn', 'dropBtn'
			];
			
			criticalElements.forEach(id => {
				const element = document.getElementById(id);
				tests.domElements.push({
					element: id,
					exists: !!element,
					status: element ? '‚úÖ' : '‚ùå'
				});
			});

			// Test 2: Check critical functions exist
			const criticalFunctions = [
				'updateStats', 'showLevelPicker', 'startLevel', 'pauseGame',
				'enterFullscreen', 'exitFullscreen', 'spawn', 'draw', 'tick'
			];
			
			criticalFunctions.forEach(funcName => {
				const exists = typeof window[funcName] === 'function';
				tests.functions.push({
					function: funcName,
					exists: exists,
					status: exists ? '‚úÖ' : '‚ùå'
				});
			});

			// Test 3: Check game logic
			tests.gameLogic.push({
				test: 'Grid dimensions',
				result: gridW === 10 && gridH === 10,
				status: (gridW === 10 && gridH === 10) ? '‚úÖ' : '‚ùå'
			});
			
			tests.gameLogic.push({
				test: 'Levels defined',
				result: Object.keys(LEVELS).length === 17,
				status: (Object.keys(LEVELS).length === 17) ? '‚úÖ' : '‚ùå'
			});

			tests.gameLogic.push({
				test: 'Game state initialized',
				result: gameState && typeof gameState.score === 'number',
				status: (gameState && typeof gameState.score === 'number') ? '‚úÖ' : '‚ùå'
			});

			// Test 4: Mobile support
			tests.mobile.push({
				test: 'Touch events supported',
				result: 'ontouchstart' in window,
				status: ('ontouchstart' in window) ? '‚úÖ' : '‚ùå'
			});

			tests.mobile.push({
				test: 'Mobile controls exist',
				result: !!(document.getElementById('leftBtn') && document.getElementById('rightBtn')),
				status: !!(document.getElementById('leftBtn') && document.getElementById('rightBtn')) ? '‚úÖ' : '‚ùå'
			});

			tests.mobile.push({
				test: 'Fullscreen available on mobile',
				result: isMobileDevice() ? !!document.getElementById('fullscreenToggle') : true,
				status: (isMobileDevice() ? !!document.getElementById('fullscreenToggle') : true) ? '‚úÖ' : '‚ùå'
			});

			// Report results
			console.log("üìä Self-Analysis Results:");
			console.log("DOM Elements:", tests.domElements);
			console.log("Functions:", tests.functions);
			console.log("Game Logic:", tests.gameLogic);
			console.log("Mobile Support:", tests.mobile);

			// Count passed/failed tests
			const allTests = [...tests.domElements, ...tests.functions, ...tests.gameLogic, ...tests.mobile];
			const passed = allTests.filter(test => test.status === '‚úÖ').length;
			const total = allTests.length;
			
			console.log(`üéØ Overall Score: ${passed}/${total} tests passed (${Math.round(passed/total*100)}%)`);
			
			if (passed === total) {
				console.log("üéâ All systems operational! Game ready for deployment.");
			} else {
				console.warn("‚ö†Ô∏è Some issues detected. Please review failed tests.");
			}

			return { passed, total, tests };
		}

		// Manual test functions - callable from console
		function testGame() {
			console.log("üß™ Running manual game tests...");
			
			// Test game functions
			try {
				console.log("Testing game board creation...");
				draw();
				console.log("‚úÖ Game board renders successfully");
			} catch (e) {
				console.error("‚ùå Game board rendering failed:", e);
			}

			try {
				console.log("Testing stats update...");
				updateStats();
				console.log("‚úÖ Stats update successfully");
			} catch (e) {
				console.error("‚ùå Stats update failed:", e);
			}

			try {
				console.log("Testing level generation...");
				const testQuestion = generateLevel0Question();
				console.log("‚úÖ Question generation works:", testQuestion);
			} catch (e) {
				console.error("‚ùå Question generation failed:", e);
			}

			return runSelfAnalysis();
		}

		// Expose test functions globally for console access
		window.testGame = testGame;
		window.runSelfAnalysis = runSelfAnalysis;

		// Removed old level selector functions - now using level picker screen

		function draw() {
			game.innerHTML = "";
			for (let y = 0; y < gridH; y++) {
				for (let x = 0; x < gridW; x++) {
					const div = document.createElement("div");
					div.className = "cell";
					if (falling && y === fy && x === fx) {
						div.classList.add("falling");
						div.textContent = falling.q;
					} else if (grid[y][x]) {
						div.classList.add("answer");
						div.textContent = grid[y][x];
					}
					game.appendChild(div);
				}
			}
		}

		function addNewRowOfNumbers() {
			// Shift all existing rows up
			for (let y = 0; y < gridH - 1; y++) {
				for (let x = 0; x < gridW; x++) {
					grid[y][x] = grid[y + 1][x];
				}
			}

			// Add new row of numbers 0-9 at the bottom
			grid[gridH - 1] = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];

			// Check for game over (if numbers reach the top)
			for (let x = 0; x < gridW; x++) {
				if (grid[0][x] !== "") {
					gameOver();
					return;
				}
			}
		}

		function collectNumber(row, col) {
			// Remove the collected number from the grid
			grid[row][col] = "";

			// Check if entire row is empty, if so shift rows down
			let rowEmpty = true;
			for (let x = 0; x < gridW; x++) {
				if (grid[row][x] !== "") {
					rowEmpty = false;
					break;
				}
			}

			if (rowEmpty && row < gridH - 1) {
				// Shift rows down to fill the gap
				for (let y = row; y < gridH - 1; y++) {
					for (let x = 0; x < gridW; x++) {
						grid[y][x] = grid[y + 1][x];
					}
				}
				// Clear the last row
				for (let x = 0; x < gridW; x++) {
					grid[gridH - 1][x] = "";
				}
			}
		}

		function checkLevelUp() {
			const requiredScore = (gameState.level + 1) * 10;
			if (gameState.score >= requiredScore && gameState.level < 16) {
				gameState.level++;
				// Unlock next level if this is the highest reached
				if (gameState.level >= gameState.unlockedLevels) {
					gameState.unlockedLevels = gameState.level + 1;
				}

				const levelName = LEVELS[gameState.level] ? LEVELS[gameState.level].name : 'Advanced';
				showStatus(`üéâ LEVEL UP! Now Level ${gameState.level}: ${levelName}`, true);
				updateStats();
			}
		}

		function gameOver() {
			clearInterval(interval);
			showStatus("üíÄ GAME OVER! Numbers reached the top!", false);
			// Could add restart functionality here
		}

		function spawn() {
			// Generate question based on current level
			switch (gameState.level) {
				case 0: falling = generateLevel0Question(); break;
				case 1: falling = generateLevel1Question(); break;
				case 2: falling = generateLevel2Question(); break;
				case 3: falling = generateLevel3Question(); break;
				case 4: falling = generateLevel4Question(); break;
				case 5: falling = generateLevel5Question(); break;
				case 6: falling = generateLevel6Question(); break;
				case 7: falling = generateLevel7Question(); break;
				case 8: falling = generateLevel8Question(); break;
				case 9: falling = generateLevel9Question(); break;
				case 10: falling = generateLevel10Question(); break;
				case 11: falling = generateLevel11Question(); break;
				case 12: falling = generateLevel12Question(); break;
				case 13: falling = generateLevel13Question(); break;
				case 14: falling = generateLevel14Question(); break;
				case 15: falling = generateLevel15Question(); break;
				case 16: falling = generateLevel16Question(); break;
				default: falling = generateLevel0Question();
			}
			fy = 0;
			fx = 5; // Start in middle
		}

		function showStatus(message, isCorrect) {
			status.innerHTML = `<div class="${isCorrect ? 'status-correct' : 'status-wrong'}">${message}</div>`;

			// Clear status after 2 seconds
			setTimeout(() => {
				status.innerHTML = `<div class="status-default">Use ‚Üê ‚Üí arrow keys to position the falling card!</div>`;
			}, 2000);
		}

		function tick() {
			if (isPaused) return; // Don't tick if game is paused

			if (!falling) {
				spawn();
				return;
			}

			if (fy < gridH - 1) {
				fy++;
			} else {
				// Card has landed - check all rows from bottom to top for the answer
				const correctAnswer = falling.a;
				let foundAnswer = false;
				let answerRow = -1;

				// Check from bottom to top for the correct answer in the current column
				for (let row = gridH - 1; row >= 0; row--) {
					if (grid[row][fx] === correctAnswer) {
						foundAnswer = true;
						answerRow = row;
						break;
					}
				}

				if (foundAnswer) {
					// Correct! Collect the number and award points
					gameState.score += 1;
					gameState.correct++;
					collectNumber(answerRow, fx);
					showStatus("‚úÖ Correct! +1 point", true);
					checkLevelUp();
				} else {
					// Wrong! Add penalty row
					gameState.wrong++;
					addNewRowOfNumbers();
					showStatus(`‚ùå Wrong! Answer was ${correctAnswer}. Row added!`, false);
				}

				updateStats();
				falling = null;
			}
			draw();
		}

		// Pause game functions
		function pauseGame() {
			isPaused = true;
			document.getElementById('pauseOverlay').style.display = 'flex';
			document.querySelector('.main-container').classList.add('game-paused');
		}

		function resumeGame() {
			isPaused = false;
			document.getElementById('pauseOverlay').style.display = 'none';
			document.querySelector('.main-container').classList.remove('game-paused');
		}

		function restartLevel() {
			// Reset current level
			gameState.score = 0;
			gameState.correct = 0;
			gameState.wrong = 0;

			// Reset grid
			initGrid();
			falling = null;

			// Resume and update
			resumeGame();
			updateStats();
			draw();

			showStatus(`Level ${gameState.level} restarted!`, true);
		}

		function saveGame() {
			saveGameState();
			showStatus("Game progress saved!", true);
			setTimeout(() => {
				resumeGame();
			}, 1000);
		}

		function exitToMainMenu() {
			// Stop game
			if (interval) clearInterval(interval);
			falling = null;
			isPaused = false;

			// Hide pause overlay
			document.getElementById('pauseOverlay').style.display = 'none';
			document.querySelector('.main-container').classList.remove('game-paused');

			// Show level picker
			showLevelPicker();
		}

		// Screen Management Functions
		function showScreen(screenId) {
			// Hide all screens
			document.querySelectorAll('.screen').forEach(screen => {
				screen.classList.remove('active');
			});

			// Show target screen
			document.getElementById(screenId).classList.add('active');
			currentScreen = screenId;
		}

		function showLoadingScreen() {
			showScreen('loadingScreen');
			startLoadingSequence();
		}

		function showLevelPicker() {
			showScreen('levelPickerScreen');
			generateLevelCards();
		}

		function showGameScreen() {
			showScreen('gameScreen');
		}

		// Loading Screen Functions
		function startLoadingSequence() {
			const loadingBar = document.getElementById('loadingBar');
			const loadingText = document.getElementById('loadingText');

			const loadingSteps = [
				{ progress: 10, text: "Loading game assets..." },
				{ progress: 30, text: "Initializing math engine..." },
				{ progress: 50, text: "Preparing level data..." },
				{ progress: 70, text: "Setting up game board..." },
				{ progress: 90, text: "Loading saved progress..." },
				{ progress: 100, text: "Ready to play!" }
			];

			let stepIndex = 0;

			function nextStep() {
				if (stepIndex < loadingSteps.length) {
					const step = loadingSteps[stepIndex];
					loadingBar.style.width = step.progress + '%';
					loadingText.textContent = step.text;
					stepIndex++;

					if (step.progress === 100) {
						setTimeout(() => {
							loadGameState(); // Load saved data
							showFullscreenButton();
						}, 800);
					} else {
						setTimeout(nextStep, 400 + Math.random() * 600);
					}
				}
			}

			// Reset and start loading
			loadingBar.style.width = '0%';
			loadingText.textContent = "Initializing...";
			setTimeout(nextStep, 500);
		}

		// Level Picker Functions
		function generateLevelCards() {
			const levelGrid = document.getElementById('levelGrid');
			levelGrid.innerHTML = '';

			// Ensure gameState is loaded
			if (!gameState.unlockedLevels) {
				gameState.unlockedLevels = 1;
			}

			Object.keys(LEVELS).forEach(levelNum => {
				const level = LEVELS[levelNum];
				const isLocked = parseInt(levelNum) >= gameState.unlockedLevels;

				const card = document.createElement('div');
				card.className = `level-card ${isLocked ? 'locked' : ''}`;

				card.innerHTML = `
      <div class="level-card-number">${level.symbol}</div>
      <div class="level-card-title">Level ${levelNum}</div>
      <div class="level-card-title">${level.name}</div>
      <div class="level-card-desc">${level.description}</div>
      ${isLocked ? '<div style="margin-top: 10px; font-weight: bold;">üîí LOCKED</div>' : ''}
    `;

				if (!isLocked) {
					card.addEventListener('click', () => {
						startLevel(parseInt(levelNum));
					});
				}

				levelGrid.appendChild(card);
			});
		}

		function startLevel(levelNum) {
			// Set up game state
			gameState.level = levelNum;
			gameState.score = 0;
			gameState.correct = 0;
			gameState.wrong = 0;

			// Initialize game
			initGrid();
			falling = null;

			// Show game screen
			showGameScreen();

			// Update UI
			updateStats();
			draw();

			// Start game loop
			if (interval) clearInterval(interval);
			interval = setInterval(tick, 1200);

			showStatus(`Level ${levelNum}: ${LEVELS[levelNum].name} - Let's begin!`, true);
		}

		document.addEventListener("keydown", e => {
			// Handle ESC key for pause
			if (e.key === "Escape") {
				if (isPaused) {
					resumeGame();
				} else {
					pauseGame();
				}
				return;
			}

			// Don't process other keys if paused or no falling card
			if (isPaused || !falling) return;

			if (e.key === "ArrowLeft" && fx > 0) {
				fx--;
			} else if (e.key === "ArrowRight" && fx < gridW - 1) {
				fx++;
			} else if (e.key === " " || e.key === "ArrowDown") {
				// Accelerate falling card - make it fall faster
				if (fy < gridH - 1) {
					fy++;
				}
			}

			draw();
		});

		// Touch/Mobile Controls
		let touchStartX = null;
		let touchStartY = null;

		document.addEventListener('touchstart', function(e) {
			// Skip if touching mobile control buttons
			if (e.target.classList.contains('mobile-btn')) return;
			
			// Only prevent default for game screen, allow normal touch for level picker
			if (currentScreen === 'gameScreen' && !isPaused && falling) {
				e.preventDefault();
				const touch = e.touches[0];
				touchStartX = touch.clientX;
				touchStartY = touch.clientY;
			}
		}, { passive: false });

		document.addEventListener('touchmove', function(e) {
			// Skip if touching mobile control buttons
			if (e.target.classList.contains('mobile-btn')) return;
			
			// Only prevent default for game screen
			if (currentScreen === 'gameScreen' && !isPaused && falling) {
				e.preventDefault();
			}
		}, { passive: false });

		document.addEventListener('touchend', function(e) {
			// Skip if touching mobile control buttons
			if (e.target.classList.contains('mobile-btn')) return;
			
			if (currentScreen !== 'gameScreen' || isPaused || !falling || touchStartX === null) return;
			
			e.preventDefault();
			const touch = e.changedTouches[0];
			const touchEndX = touch.clientX;
			const touchEndY = touch.clientY;
			
			const deltaX = touchEndX - touchStartX;
			const deltaY = touchEndY - touchStartY;
			
			// Minimum swipe distance
			const minSwipe = 30;
			
			if (Math.abs(deltaX) > Math.abs(deltaY)) {
				// Horizontal swipe
				if (Math.abs(deltaX) > minSwipe) {
					if (deltaX > 0 && fx < gridW - 1) {
						fx++; // Swipe right
					} else if (deltaX < 0 && fx > 0) {
						fx--; // Swipe left
					}
				}
			} else {
				// Vertical swipe down or tap
				if (deltaY > minSwipe || Math.abs(deltaX) < minSwipe && Math.abs(deltaY) < minSwipe) {
					// Swipe down or tap - accelerate falling
					if (fy < gridH - 1) {
						fy++;
					}
				}
			}
			
			touchStartX = null;
			touchStartY = null;
			draw();
		}, { passive: false });

		// Add mobile pause button
		function addMobilePauseButton() {
			if (window.innerWidth <= 768 && currentScreen === 'gameScreen') {
				// Mobile pause is handled by the existing Level Select button in title
				return;
			}
		}

		// Initialize grid with numbers 0-9 on bottom row
		function initGrid() {
			grid = Array.from({ length: gridH }, () => Array(gridW).fill(""));
			grid[gridH - 1] = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
		}

		// Add event listeners for pause menu
		function addPauseMenuListeners() {
			document.getElementById('continueBtn').addEventListener('click', resumeGame);
			document.getElementById('restartBtn').addEventListener('click', restartLevel);
			document.getElementById('saveBtn').addEventListener('click', saveGame);
			document.getElementById('exitBtn').addEventListener('click', exitToMainMenu);
		}

		// Check if device is mobile
		function isMobileDevice() {
			return window.innerWidth <= 768 || 'ontouchstart' in window || navigator.maxTouchPoints > 0;
		}

		// Fullscreen functionality (mobile only)
		function showFullscreenButton() {
			const fullscreenBtn = document.getElementById('fullscreenBtn');
			const loadingText = document.getElementById('loadingText');
			
			loadingText.textContent = "Game loaded successfully!";
			
			// Only show fullscreen button on mobile devices
			if (isMobileDevice()) {
				fullscreenBtn.style.display = 'block';
				
				fullscreenBtn.addEventListener('click', function() {
					enterFullscreen();
					showLevelPicker();
				});
			} else {
				// On desktop, skip fullscreen and go directly to level picker
				showLevelPicker();
			}
		}

		function enterFullscreen() {
			const elem = document.documentElement;

			// For iOS Safari, we need to use a different approach
			if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
				// iOS Safari has limited fullscreen support
				// Instead, we'll hide the browser UI by scrolling and using viewport
				document.body.style.height = '100vh';
				document.documentElement.style.height = '100vh';
				window.scrollTo(0, 1);

				// Add a class to help with iOS styling
				document.body.classList.add('ios-fullscreen');
			} else {
				// Standard fullscreen API for other devices
				if (elem.requestFullscreen) {
					elem.requestFullscreen().catch(e => console.log('Fullscreen failed:', e));
				} else if (elem.webkitRequestFullscreen) { /* Safari */
					elem.webkitRequestFullscreen();
				} else if (elem.msRequestFullscreen) { /* IE11 */
					elem.msRequestFullscreen();
				}
			}
		}

		function exitFullscreen() {
			// Handle iOS fullscreen exit
			if (document.body.classList.contains('ios-fullscreen')) {
				document.body.classList.remove('ios-fullscreen');
				document.body.style.height = '';
				document.documentElement.style.height = '';
				window.scrollTo(0, 0);
			} else {
				// Standard fullscreen API
				if (document.exitFullscreen) {
					document.exitFullscreen().catch(e => console.log('Exit fullscreen failed:', e));
				} else if (document.webkitExitFullscreen) { /* Safari */
					document.webkitExitFullscreen();
				} else if (document.msExitFullscreen) { /* IE11 */
					document.msExitFullscreen();
				}
			}
		}

		function toggleFullscreen() {
			// Only allow fullscreen toggle on mobile devices
			if (!isMobileDevice()) {
				return;
			}

			// Check if we're in fullscreen mode
			const isInFullscreen = document.fullscreenElement ||
								   document.webkitFullscreenElement ||
								   document.msFullscreenElement ||
								   document.body.classList.contains('ios-fullscreen');

			if (isInFullscreen) {
				exitFullscreen();
			} else {
				enterFullscreen();
			}
		}

		// Add mobile button event listeners
		function addMobileControls() {
			const leftBtn = document.getElementById('leftBtn');
			const rightBtn = document.getElementById('rightBtn');
			const dropBtn = document.getElementById('dropBtn');

			function moveLeft(e) {
				e.preventDefault();
				e.stopPropagation();
				if (currentScreen === 'gameScreen' && !isPaused && falling && fx > 0) {
					fx--;
					draw();
				}
			}

			function moveRight(e) {
				e.preventDefault();
				e.stopPropagation();
				if (currentScreen === 'gameScreen' && !isPaused && falling && fx < gridW - 1) {
					fx++;
					draw();
				}
			}

			function dropPiece(e) {
				e.preventDefault();
				e.stopPropagation();
				if (currentScreen === 'gameScreen' && !isPaused && falling && fy < gridH - 1) {
					fy++;
					draw();
				}
			}

			if (leftBtn) {
				leftBtn.addEventListener('click', moveLeft);
				leftBtn.addEventListener('touchend', moveLeft);
				leftBtn.addEventListener('touchstart', function(e) {
					e.preventDefault();
					e.stopPropagation();
				});
			}

			if (rightBtn) {
				rightBtn.addEventListener('click', moveRight);
				rightBtn.addEventListener('touchend', moveRight);
				rightBtn.addEventListener('touchstart', function(e) {
					e.preventDefault();
					e.stopPropagation();
				});
			}

			if (dropBtn) {
				dropBtn.addEventListener('click', dropPiece);
				dropBtn.addEventListener('touchend', dropPiece);
				dropBtn.addEventListener('touchstart', function(e) {
					e.preventDefault();
					e.stopPropagation();
				});
			}
		}

		// Initialize game
		function initGame() {
			// Add event listeners
			addPauseMenuListeners();
			addMobileControls();
			
			// Add fullscreen toggle listener (mobile only)
			const fullscreenToggle = document.getElementById('fullscreenToggle');
			if (fullscreenToggle && isMobileDevice()) {
				fullscreenToggle.addEventListener('click', function(e) {
					e.preventDefault();
					toggleFullscreen();
				});
				fullscreenToggle.addEventListener('touchstart', function(e) {
					e.preventDefault();
					e.stopPropagation();
				});
				fullscreenToggle.addEventListener('touchend', function(e) {
					e.preventDefault();
					e.stopPropagation();
					toggleFullscreen();
				});
			}

			// Add level picker and pause button listeners
			const levelPickerBtn = document.getElementById('levelPickerBtn');
			const pauseBtn = document.getElementById('pauseBtn');

			if (levelPickerBtn) {
				// Add both click and touch events for better mobile support
				levelPickerBtn.addEventListener('click', function(e) {
					e.preventDefault();
					showLevelPicker();
				});
				levelPickerBtn.addEventListener('touchstart', function(e) {
					e.preventDefault();
					e.stopPropagation();
				});
				levelPickerBtn.addEventListener('touchend', function(e) {
					e.preventDefault();
					e.stopPropagation();
					showLevelPicker();
				});
			}

			if (pauseBtn) {
				// Add both click and touch events for better mobile support
				pauseBtn.addEventListener('click', function(e) {
					e.preventDefault();
					pauseGame();
				});
				pauseBtn.addEventListener('touchstart', function(e) {
					e.preventDefault();
					e.stopPropagation();
				});
				pauseBtn.addEventListener('touchend', function(e) {
					e.preventDefault();
					e.stopPropagation();
					pauseGame();
				});
			}

			// Run self-analysis after DOM is ready
			setTimeout(() => {
				const analysis = runSelfAnalysis();
				if (analysis.passed < analysis.total) {
					console.warn("üîß Game has issues but will attempt to run anyway");
				}
			}, 100);

			// Start with loading screen
			showLoadingScreen();
		}

		// Start the game when page loads
		initGame();
	</script>
</body>

</html>